<?xml version="1.0" encoding="UTF-8"?>
<upgrade dataSourceName="TRADE" databaseVersion="24.00">
	<sql  type ="procedure">
    <![CDATA[
	
CREATE OR ALTER PROCEDURE NEW_PROCEDURE 
returns (
    r3 integer,
    r2 integer,
    s1 varchar(100),
    r1 integer)
as
declare variable name varchar(48);
declare variable nick varchar(48);
declare variable c integer;
declare variable a integer;
declare variable b integer;
begin
  /* Procedure Text */
  for select distinct BUYER_NICK
      from TRADE
      group by BUYER_NICK
      into :NICK
  do
  begin
    for select count(*)
        from TRADE
        where BUYER_NICK = :NICK
        into :C
    do
    begin
      if (:C = 1) then
      begin
        update TRADE
        set MULTI_BUYER_NICK = ''
        where BUYER_NICK = :NICK;
        break;
      end
      for select count(distinct coalesce(TRADE.RECEIVER_NAME, ''))
          from TRADE
          where BUYER_NICK = :NICK
          into :A
      do
      begin
        break;
      end

      for select count(distinct coalesce(TRADE.RECEIVER_STATE, '') || coalesce(TRADE.RECEIVER_CITY, '') || coalesce(TRADE.RECEIVER_DISTRICT, '') || coalesce(TRADE.RECEIVER_ADDRESS, ''))
          from TRADE
          where BUYER_NICK = :NICK
          into :B
      do
      begin
        break;
      end

      if (A = B and
          B = 1) then
        update TRADE
        set MULTI_BUYER_NICK = '【多单】'
        where BUYER_NICK = :NICK;
      if (A = 1 and
          B <> 1) then
        update TRADE
        set MULTI_BUYER_NICK = '【多单A】'
        where BUYER_NICK = :NICK;
      if (B = 1 and
          A <> 1) then
        update TRADE
        set MULTI_BUYER_NICK = '【多单B】'
        where BUYER_NICK = :NICK;
      if (A <> 1 and
          B <> 1) then
        update TRADE
        set MULTI_BUYER_NICK = '【多单C】'
        where BUYER_NICK = :NICK;

    end

  end
end
	]]>
	</sql>
</upgrade>